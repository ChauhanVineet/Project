<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Gym Coach">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="theme-color" content="#FF3B30">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gym Coach ‚Äì Your Personal Trainer</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --red:#FF3B30;--teal:#00C9A7;--dark:#0F0F14;--card:#1A1A24;--card2:#22222F;
  --border:#2E2E3E;--text:#F0F0F5;--muted:#6E6E8A;--yellow:#FFD60A;
  --font-display:'Bebas Neue',sans-serif;--font-body:'DM Sans',sans-serif;
}
body{background:var(--dark);color:var(--text);font-family:var(--font-body);min-height:100vh;overflow-x:hidden;}

/* BG grain */
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");pointer-events:none;z-index:0;opacity:.5;}

/* Layout */
#app{position:relative;z-index:1;max-width:100%;min-height:100vh;}

/* Nav - left sidebar */
nav{position:fixed;top:0;left:0;bottom:0;width:72px;
  background:rgba(15,15,20,.97);backdrop-filter:blur(20px);
  border-right:1px solid var(--border);display:flex;flex-direction:column;
  align-items:center;padding:24px 0 16px;gap:4px;z-index:100;}
.nav-item{width:56px;display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:10px 4px;cursor:pointer;color:var(--muted);transition:.2s;border:none;
  background:none;font-family:var(--font-body);border-radius:14px;}
.nav-item:hover{background:rgba(255,255,255,.04);}
.nav-item .ico{font-size:22px;}
.nav-item span{font-size:9px;font-weight:600;letter-spacing:.3px;text-transform:uppercase;}
.nav-item.active{color:var(--red);background:rgba(255,59,48,.1);}

/* Pages */
.page{display:none;padding:20px 20px 20px 88px;}
#home{padding:14px 14px 14px 88px;}
.page.active{display:block;animation:fadeUp .3s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

/* Headings */
.page-title{font-family:var(--font-display);font-size:42px;letter-spacing:1px;margin-bottom:4px;}
.page-sub{color:var(--muted);font-size:14px;margin-bottom:28px;}

/* HOME */
.home-header{padding-top:20px;}
.greeting{font-family:var(--font-display);font-size:38px;letter-spacing:2px;line-height:1;margin-bottom:6px;}
.greeting span{color:var(--red);}
.date-chip{display:inline-flex;align-items:center;gap:6px;background:var(--card2);border:1px solid var(--border);
  border-radius:20px;padding:4px 14px;font-size:12px;color:var(--muted);margin-bottom:24px;}

.workout-picker-card{background:var(--card);border:1.5px solid var(--border);
  border-radius:20px;padding:20px;margin-bottom:20px;}
.workout-picker-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.workout-picker-title{font-family:var(--font-display);font-size:18px;letter-spacing:1px;color:var(--muted);}
.workout-picker-hint{font-size:12px;color:var(--teal);font-weight:600;}
.picker-option{display:flex;align-items:center;gap:12px;padding:13px 16px;border-radius:12px;
  cursor:pointer;transition:.2s;border:2px solid transparent;margin-bottom:8px;background:var(--card2);}
.picker-option:last-child{margin-bottom:0;}
.picker-option:hover{border-color:var(--border);}
.picker-option.selected{border-color:var(--red);background:rgba(255,59,48,.08);}
.picker-radio{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:.2s;}
.picker-option.selected .picker-radio{border-color:var(--red);background:var(--red);}
.picker-radio-dot{width:8px;height:8px;border-radius:50%;background:#fff;display:none;}
.picker-option.selected .picker-radio-dot{display:block;}
.picker-name{font-weight:700;font-size:15px;flex:1;}
.picker-meta{font-size:12px;color:var(--muted);}
.picker-badge{font-size:11px;background:rgba(0,201,167,.2);color:var(--teal);
  padding:2px 8px;border-radius:20px;font-weight:700;white-space:nowrap;}
.picker-empty{color:var(--muted);font-size:14px;text-align:center;padding:16px 0;}

/* removed old stats-row - now in home-card */
.home-two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.home-card{background:var(--card);border:1.5px solid var(--border);border-radius:20px;padding:16px;
  display:flex;flex-direction:column;gap:8px;
  height:calc(100dvh - 200px);max-height:480px;overflow:hidden;}
.home-card-primary{border-color:rgba(255,59,48,.3);}
.home-card-title{font-family:var(--font-display);font-size:16px;letter-spacing:1.5px;color:var(--muted);}
.home-card-hint{font-size:11px;color:var(--teal);font-weight:600;min-height:14px;}
#homeWorkoutPicker{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.picker-option{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;
  cursor:pointer;transition:.2s;border:1.5px solid transparent;background:var(--card2);}
.picker-option:hover{border-color:var(--border);}
.picker-option.selected{border-color:var(--red);background:rgba(255,59,48,.08);}
.picker-radio{width:14px;height:14px;border-radius:50%;border:2px solid var(--border);
  flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:.2s;}
.picker-option.selected .picker-radio{border-color:var(--red);background:var(--red);}
.picker-radio-dot{width:6px;height:6px;border-radius:50%;background:#fff;display:none;}
.picker-option.selected .picker-radio-dot{display:block;}
.picker-name{font-weight:700;font-size:13px;flex:1;line-height:1.2;}
.picker-meta{font-size:11px;color:var(--muted);}
.picker-badge{font-size:10px;background:rgba(0,201,167,.2);color:var(--teal);
  padding:2px 6px;border-radius:20px;font-weight:700;white-space:nowrap;}
.picker-empty{color:var(--muted);font-size:12px;text-align:center;padding:16px 0;line-height:1.6;}
.btn-start{width:100%;padding:13px;background:var(--red);color:#fff;border:none;border-radius:12px;
  font-family:var(--font-display);font-size:20px;letter-spacing:2px;cursor:pointer;
  transition:.2s;box-shadow:0 6px 18px rgba(255,59,48,.3);margin-top:auto;}
.btn-start:hover{transform:translateY(-2px);}
.perf-stat{display:flex;flex-direction:column;gap:2px;}
.perf-val{font-family:var(--font-display);font-size:28px;color:var(--teal);line-height:1;}
.perf-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600;}
.perf-since{font-size:10px;color:var(--muted);margin-top:auto;padding-top:8px;border-top:1px solid var(--border);}
/* keep these for backward compat */
.stat-num,.stat-lbl,.stats-row,.stat-box{}

.btn-hero{width:100%;padding:18px;background:var(--red);color:#fff;border:none;border-radius:14px;
  font-family:var(--font-display);font-size:26px;letter-spacing:2px;cursor:pointer;
  transition:.2s;margin-bottom:12px;box-shadow:0 8px 24px rgba(255,59,48,.3);}
.btn-hero:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(255,59,48,.4);}
.btn-ghost{width:100%;padding:14px;background:transparent;color:var(--text);border:2px solid var(--border);
  border-radius:14px;font-family:var(--font-body);font-size:15px;font-weight:600;cursor:pointer;transition:.2s;}
.btn-ghost:hover{border-color:var(--muted);}

.section-title{font-family:var(--font-display);font-size:22px;letter-spacing:1px;margin-bottom:14px;}

/* WORKOUT CREATE */
.form-input{width:100%;padding:14px 16px;background:var(--card);border:1.5px solid var(--border);
  border-radius:12px;color:var(--text);font-family:var(--font-body);font-size:15px;margin-bottom:12px;transition:.2s;}
.form-input:focus{outline:none;border-color:var(--red);}
.form-input::placeholder{color:var(--muted);}
select.form-input option{background:var(--card2);}

.exercise-card{background:var(--card);border:1.5px solid var(--border);border-radius:16px;padding:18px;margin-bottom:12px;}
.ex-card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.ex-card-header strong{font-size:14px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
.remove-btn{background:rgba(255,59,48,.15);color:var(--red);border:none;border-radius:8px;
  padding:6px 12px;font-size:13px;cursor:pointer;font-weight:600;}
.sets-reps{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
.btn-add{width:100%;padding:14px;background:var(--card2);color:var(--teal);border:1.5px dashed var(--teal);
  border-radius:12px;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:12px;transition:.2s;}
.btn-add:hover{background:rgba(0,201,167,.1);}
.btn-save{width:100%;padding:16px;background:var(--teal);color:var(--dark);border:none;border-radius:12px;
  font-family:var(--font-display);font-size:24px;letter-spacing:2px;cursor:pointer;transition:.2s;}
.btn-save:hover{transform:translateY(-2px);}

.workout-card{background:var(--card);border:1.5px solid var(--border);border-radius:14px;padding:18px;
  margin-bottom:10px;transition:.2s;display:flex;justify-content:space-between;align-items:center;}
.workout-card:hover{border-color:var(--red);}
.workout-card-actions{display:flex;align-items:center;gap:8px;flex-shrink:0;}
.wc-btn{border:none;border-radius:8px;padding:6px 12px;font-size:13px;font-weight:600;cursor:pointer;transition:.2s;}
.wc-edit{background:rgba(0,201,167,.15);color:var(--teal);}
.wc-edit:hover{background:rgba(0,201,167,.3);}
.wc-delete{background:rgba(255,59,48,.15);color:var(--red);}
.wc-delete:hover{background:rgba(255,59,48,.3);}
.form-mode-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.form-mode-title{font-family:var(--font-display);font-size:18px;letter-spacing:1px;color:var(--muted);}
.cancel-edit-btn{background:rgba(255,59,48,.15);color:var(--red);border:none;border-radius:8px;
  padding:8px 14px;font-size:13px;font-weight:700;cursor:pointer;}
.cancel-edit-btn:hover{background:rgba(255,59,48,.3);}

/* ACTIVE WORKOUT */
#activeWorkout{padding:16px 20px 20px 88px;}
.active-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.active-title{font-family:var(--font-display);font-size:28px;letter-spacing:1px;}
.end-btn{background:rgba(255,59,48,.2);color:var(--red);border:none;border-radius:10px;
  padding:8px 16px;font-weight:700;cursor:pointer;font-size:14px;}
.active-content{padding:0;}
.ex-progress{background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:14px;}
.ex-progress-head{padding:16px 18px 12px;border-bottom:1px solid var(--border);}
.ex-name{font-weight:700;font-size:17px;}
.ex-meta{font-size:12px;color:var(--muted);margin-top:2px;}
.set-row{display:grid;grid-template-columns:24px 1fr 1fr 24px;gap:6px;align-items:center;padding:8px 14px;}
.set-status{font-size:14px;color:var(--teal);font-weight:700;text-align:center;}
.rep-play-btn{background:var(--red);color:#fff;border:none;border-radius:10px;
  padding:8px 14px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;white-space:nowrap;}
.rep-play-btn:hover:not(:disabled){transform:scale(1.03);}
.rep-play-btn:disabled{opacity:.5;cursor:default;}
.rep-counter-panel{flex-direction:column;align-items:center;background:rgba(255,59,48,.06);
  border:1.5px solid rgba(255,59,48,.25);border-radius:14px;padding:16px;margin:8px 14px;gap:4px;}
.rcp-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;font-weight:700;}
.rcp-count{font-family:var(--font-display);font-size:72px;color:var(--red);line-height:1;}
.rcp-target{font-size:13px;color:var(--muted);}
.rcp-status{font-size:13px;color:var(--teal);font-weight:600;min-height:18px;}
.set-row+.set-row{border-top:1px solid rgba(255,255,255,.04);}
.set-num{font-size:13px;color:var(--muted);font-weight:700;text-align:center;}
.set-input{background:var(--card2);border:1.5px solid var(--border);border-radius:8px;
  color:var(--text);font-family:var(--font-body);font-size:14px;padding:8px 10px;text-align:center;}
.set-input:focus{outline:none;border-color:var(--teal);}
.set-done-btn{background:var(--card2);border:1.5px solid var(--border);border-radius:8px;
  color:var(--text);font-size:13px;font-weight:700;padding:8px 0;cursor:pointer;transition:.2s;}
.set-done-btn:hover:not(:disabled){border-color:var(--teal);color:var(--teal);}
.set-row.done .set-done-btn{background:rgba(0,201,167,.2);border-color:var(--teal);color:var(--teal);}
.set-row.done .set-input{opacity:.4;pointer-events:none;}

/* Rest overlay */
.ex-one-row{display:flex;flex-direction:column;gap:8px;}
.ex-dropdowns{display:flex;gap:8px;}
.ex-dropdowns .form-input{flex:1;margin-bottom:0;min-width:0;}
.ex-numbers{display:flex;gap:8px;}
.ex-mini-field{display:flex;flex-direction:column;gap:3px;flex:1;}
.ex-mini-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;text-align:center;font-weight:600;}
.ex-mini-field .form-input{width:100%;text-align:center;margin-bottom:0;}
/* set-timer CSS removed */
#restOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);
  z-index:200;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
#restOverlay.show{display:flex;}
.rest-title{font-family:var(--font-display);font-size:28px;letter-spacing:2px;color:var(--muted);margin-bottom:8px;}
.rest-num{font-family:var(--font-display);font-size:120px;color:var(--yellow);line-height:1;margin-bottom:24px;}
.rest-skip{background:var(--card2);border:1.5px solid var(--border);color:var(--text);
  border-radius:12px;padding:14px 40px;font-size:16px;font-weight:700;cursor:pointer;}

/* PROGRESS */
.measure-form{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin-bottom:20px;align-items:end;}
.btn-sm{padding:14px 20px;background:var(--teal);color:var(--dark);border:none;border-radius:12px;
  font-weight:700;cursor:pointer;font-size:15px;}
.history-list{display:flex;flex-direction:column;gap:10px;margin-bottom:30px;}
.history-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 18px;
  display:flex;justify-content:space-between;align-items:center;}
.history-row-left strong{font-size:15px;}
.history-row-left span{font-size:12px;color:var(--muted);display:block;margin-top:2px;}
.history-row-right{text-align:right;}
.history-val{font-family:var(--font-display);font-size:22px;color:var(--teal);}
.history-val-sub{font-size:12px;color:var(--muted);}

/* NUTRITION */
.macro-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px;}
.macro-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;}
.macro-box-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.macro-box-val{font-family:var(--font-display);font-size:36px;color:var(--red);line-height:1;}
.macro-box-target{font-size:12px;color:var(--muted);margin-top:4px;}
.macro-box:first-child{grid-column:span 2;}
.macro-box:first-child .macro-box-val{font-size:52px;}

/* progress bar */
.pbar{background:var(--card2);border-radius:4px;height:4px;margin-top:10px;overflow:hidden;}
.pbar-fill{height:100%;background:var(--red);border-radius:4px;transition:.5s;}
.macro-box:nth-child(2) .pbar-fill{background:var(--teal);}
.macro-box:nth-child(3) .pbar-fill{background:var(--yellow);}
.macro-box:nth-child(4) .pbar-fill{background:#FF6930;}

.meal-form-grid{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:20px;}
.meal-form-grid h3{font-family:var(--font-display);font-size:20px;letter-spacing:1px;margin-bottom:14px;}
.macros-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.btn-log{width:100%;padding:14px;margin-top:12px;background:var(--red);color:#fff;border:none;
  border-radius:12px;font-family:var(--font-display);font-size:22px;letter-spacing:2px;cursor:pointer;}
.meal-item{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 18px;margin-bottom:10px;}
.meal-name{font-weight:700;font-size:15px;margin-bottom:6px;}
.meal-macros{display:flex;gap:12px;font-size:13px;color:var(--muted);}
.meal-macros span{background:var(--card2);padding:2px 8px;border-radius:6px;}

/* Empty state */
.empty{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-ico{font-size:48px;margin-bottom:12px;}

/* Scrollbar */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* Toast */
#toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-80px);
  background:var(--teal);color:var(--dark);padding:12px 24px;border-radius:30px;
  font-weight:700;font-size:14px;z-index:300;transition:.3s;}
#toast.show{transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>
<div id="app">
  <!-- Toast -->
  <div id="toast"></div>

  <!-- ===== HOME ===== -->
  <div class="page active" id="home">
    <div class="date-chip">üìÖ <span id="todayDate"></span></div>
    <div class="greeting">LET'S<br><span>WORK.</span></div>
    <div class="home-two-col">
      <!-- LEFT: Workout Picker -->
      <div class="home-card home-card-primary">
        <div class="home-card-title">TODAY'S WORKOUT</div>
        <div class="home-card-hint" id="pickerHint"></div>
        <div id="homeWorkoutPicker"><div class="picker-empty">No workouts yet.<br>Go to Workout tab to create one.</div></div>
        <button class="btn-start" onclick="startSelectedWorkout()">‚ñ∂ START</button>
      </div>
      <!-- RIGHT: Performance -->
      <div class="home-card home-card-perf">
        <div class="home-card-title">PERFORMANCE</div>
        <div class="perf-stat"><div class="perf-val" id="totalWorkouts">0</div><div class="perf-lbl">Sessions</div></div>
        <div class="perf-stat"><div class="perf-val" id="currentStreak">0</div><div class="perf-lbl">Day Streak</div></div>
        <div class="perf-stat"><div class="perf-val" id="totalWeight">0</div><div class="perf-lbl">kg Lifted</div></div>
        <div class="perf-stat"><div class="perf-val" id="avgDuration">‚Äî</div><div class="perf-lbl">Avg Min</div></div>
        <div class="perf-since" id="perfSince"></div>
      </div>
    </div>
  </div>

  <!-- ===== WORKOUT CREATE ===== -->
  <div class="page" id="workout">
    <div class="page-title">WORKOUTS</div>
    <div class="page-sub">Build & manage your routines</div>

    <button class="btn-hero" onclick="openCreateForm()" style="margin-bottom:20px;">+ CREATE NEW WORKOUT</button>
    <div id="workoutFormSection" style="display:none;">
      <div class="form-mode-bar">
        <span id="formTitle" class="form-mode-title">CREATE NEW WORKOUT</span>
        <button id="cancelEditBtn" class="cancel-edit-btn" style="display:none;" onclick="resetWorkoutForm()">‚úï Cancel Edit</button>
      </div>
      <input type="text" id="workoutName" class="form-input" placeholder="Workout name (e.g. Push Day)">
      <div id="exerciseList"></div>
      <button class="btn-add" onclick="addExercise()">+ Add Exercise</button>
      <button id="saveWorkoutBtn" class="btn-save" onclick="saveWorkout()">SAVE WORKOUT</button>
    </div>

    <div style="margin-top:32px;">
      <div class="section-title">SAVED ROUTINES</div>
      <div id="savedWorkoutsList"><div class="empty"><div class="empty-ico">üèóÔ∏è</div>No workouts yet. Create one above!</div></div>
    </div>
  </div>

  <!-- ===== ACTIVE WORKOUT ===== -->
  <div class="page" id="activeWorkout">
    <div class="active-header">
      <div>
        <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Now Training</div>
        <div class="active-title" id="activeWorkoutName">Workout</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <div id="workoutTimer" style="font-family:var(--font-display);font-size:20px;color:var(--muted);letter-spacing:2px;">00:00</div>
        <button class="end-btn" onclick="endWorkout()">END</button>
      </div>
    </div>
    <div class="active-content" id="exerciseProgress"></div>
  </div>

  <!-- ===== PROGRESS ===== -->
  <div class="page" id="progress">
    <div class="page-title">PROGRESS</div>
    <div class="page-sub">Track measurements & history</div>

    <div class="section-title">BODY MEASUREMENTS</div>
    <div class="measure-form">
      <input type="number" id="weightInput" class="form-input" placeholder="Weight (kg)" style="margin-bottom:0;">
      <input type="number" id="bodyFatInput" class="form-input" placeholder="Body Fat %" style="margin-bottom:0;">
      <button class="btn-sm" onclick="saveMeasurement()">Save</button>
    </div>
    <div id="measurementHistory" class="history-list"></div>

    <div class="section-title">WORKOUT HISTORY</div>
    <div id="workoutHistory" class="history-list"></div>
  </div>

  <!-- ===== NUTRITION ===== -->
  <div class="page" id="nutrition">
    <div class="page-title">NUTRITION</div>
    <div class="page-sub">Today's fuel log</div>

    <div class="macro-grid">
      <div class="macro-box">
        <div class="macro-box-label">üî• Calories</div>
        <div class="macro-box-val" id="calConsumed">0</div>
        <div class="macro-box-target">of <span id="calTarget">2500</span> kcal</div>
        <div class="pbar"><div class="pbar-fill" id="calBar" style="width:0%"></div></div>
      </div>
      <div class="macro-box">
        <div class="macro-box-label">ü•© Protein</div>
        <div class="macro-box-val" id="proConsumed">0</div>
        <div class="macro-box-target">of <span id="proTarget">150</span>g</div>
        <div class="pbar"><div class="pbar-fill" id="proBar" style="width:0%"></div></div>
      </div>
      <div class="macro-box">
        <div class="macro-box-label">üåæ Carbs</div>
        <div class="macro-box-val" id="carbConsumed">0</div>
        <div class="macro-box-target">of <span id="carbTarget">300</span>g</div>
        <div class="pbar"><div class="pbar-fill" id="carbBar" style="width:0%"></div></div>
      </div>
      <div class="macro-box">
        <div class="macro-box-label">ü•ë Fats</div>
        <div class="macro-box-val" id="fatConsumed">0</div>
        <div class="macro-box-target">of <span id="fatTarget">80</span>g</div>
        <div class="pbar"><div class="pbar-fill" id="fatBar" style="width:0%"></div></div>
      </div>
    </div>

    <div class="meal-form-grid">
      <h3>LOG MEAL</h3>
      <input type="text" id="mealName" class="form-input" placeholder="Meal name">
      <input type="number" id="mealCal" class="form-input" placeholder="Calories">
      <div class="macros-row">
        <input type="number" id="mealPro" class="form-input" placeholder="Protein (g)" style="margin-bottom:0;">
        <input type="number" id="mealCarb" class="form-input" placeholder="Carbs (g)" style="margin-bottom:0;">
        <input type="number" id="mealFat" class="form-input" placeholder="Fats (g)" style="margin-bottom:0;">
        <button class="btn-log" onclick="logMeal()">LOG</button>
      </div>
    </div>

    <div class="section-title">TODAY'S MEALS</div>
    <div id="mealsList"></div>
  </div>

  <!-- Nav -->
  <nav>
    <button class="nav-item active" data-page="home" onclick="navTo('home',this)">
      <span class="ico">üè†</span><span>Home</span>
    </button>
    <button class="nav-item" data-page="workout" onclick="navTo('workout',this)">
      <span class="ico">üí™</span><span>Workout</span>
    </button>
    <button class="nav-item" data-page="progress" onclick="navTo('progress',this)">
      <span class="ico">üìä</span><span>Progress</span>
    </button>
    <button class="nav-item" data-page="nutrition" onclick="navTo('nutrition',this)">
      <span class="ico">ü•ó</span><span>Nutrition</span>
    </button>
  </nav>

  <!-- Rest Overlay -->
  <div id="restOverlay">
    <div class="rest-title">REST TIME</div>
    <div class="rest-num" id="restNum">60</div>
    <button class="rest-skip" onclick="skipRest()">Skip Rest ‚Üí</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ
let workouts = JSON.parse(localStorage.getItem('gc_workouts') || localStorage.getItem('workouts') || '[]');
let workoutHistory = JSON.parse(localStorage.getItem('gc_history') || localStorage.getItem('workoutHistory') || '[]');
let measurements = JSON.parse(localStorage.getItem('gc_measurements') || localStorage.getItem('measurements') || '[]');
let meals = JSON.parse(localStorage.getItem('gc_meals') || localStorage.getItem('meals') || '[]');
let currentWorkout = null, workoutStartTime = null;
let workoutTimerInt = null, restTimerInt = null;
let exCount = 0;
let editingIndex = -1; // -1 = creating new, >=0 = editing existing



// Exercise DB
const exerciseDB = {
  chest:[
    'Barbell Bench Press','Dumbbell Bench Press',
    'Incline Barbell Bench Press','Incline Dumbbell Press','Incline Dumbbell Flyes',
    'Decline Barbell Bench Press','Decline Dumbbell Press',
    'Flat Dumbbell Flyes','Cable Crossover (Low-to-High)','Cable Crossover (High-to-Low)',
    'Pec Deck Machine','Chest Press Machine','Hammer Strength Chest Press',
    'Push-Ups','Wide-Grip Push-Ups','Diamond Push-Ups','Archer Push-Ups',
    'Dips (Chest Focus)','Svend Press','Landmine Press',
    'Single-Arm Cable Fly','Resistance Band Chest Press'
  ],
  back:[
    'Conventional Deadlift','Sumo Deadlift','Romanian Deadlift','Stiff-Leg Deadlift',
    'Barbell Row (Overhand)','Barbell Row (Underhand)','Pendlay Row','T-Bar Row',
    'Dumbbell Row (Single Arm)','Chest-Supported Dumbbell Row','Meadows Row',
    'Lat Pulldown (Wide Grip)','Lat Pulldown (Close Grip)','Lat Pulldown (Reverse Grip)',
    'Pull-Ups (Wide Grip)','Pull-Ups (Close Grip)','Chin-Ups','Neutral-Grip Pull-Ups',
    'Seated Cable Row (Wide)','Seated Cable Row (Close Grip)','Cable Straight-Arm Pulldown',
    'Face Pulls','Rack Pull','Good Morning',
    'Hyperextensions','Reverse Hyperextensions','Back Extension Machine',
    'Shrugs (Barbell)','Shrugs (Dumbbell)','Shrugs (Cable)'
  ],
  legs:[
    'Barbell Back Squat','Barbell Front Squat','Hack Squat Machine','Smith Machine Squat',
    'Leg Press (Wide Stance)','Leg Press (Narrow Stance)','Leg Press (Single Leg)',
    'Romanian Deadlift','Stiff-Leg Deadlift','Good Morning',
    'Leg Curl (Lying)','Leg Curl (Seated)','Leg Curl (Standing)',
    'Leg Extension','Single-Leg Extension',
    'Walking Lunges','Reverse Lunges','Lateral Lunges','Stationary Lunges',
    'Bulgarian Split Squat','Step-Ups','Box Jumps',
    'Goblet Squat','Sumo Squat','Pistol Squat',
    'Calf Raises (Standing)','Calf Raises (Seated)','Calf Press on Leg Press',
    'Hip Thrust (Barbell)','Hip Thrust (Machine)','Glute Bridge','Cable Kickbacks',
    'Abductor Machine','Adductor Machine','Monster Walks (Band)'
  ],
  shoulders:[
    'Barbell Overhead Press','Dumbbell Shoulder Press','Machine Shoulder Press',
    'Smith Machine OHP','Seated Dumbbell Press','Arnold Press',
    'Lateral Raises (Dumbbell)','Lateral Raises (Cable)','Lateral Raises (Machine)',
    'Front Raises (Dumbbell)','Front Raises (Barbell)','Front Raises (Cable)',
    'Rear Delt Flyes (Dumbbell)','Rear Delt Flyes (Cable)','Reverse Pec Deck',
    'Face Pulls','Upright Row (Barbell)','Upright Row (Cable)','Upright Row (Dumbbell)',
    'Shrugs (Barbell)','Shrugs (Dumbbell)','Push Press','Landmine Press',
    'Plate Front Raise','Cable Y-Raise','Bradford Press'
  ],
  biceps:[
    'Barbell Curl','EZ Bar Curl','Dumbbell Curl (Alternating)','Dumbbell Curl (Simultaneous)',
    'Hammer Curl','Cross-Body Hammer Curl','Reverse Curl (Barbell)','Reverse Curl (EZ Bar)',
    'Preacher Curl (Barbell)','Preacher Curl (Dumbbell)','Preacher Curl (Machine)',
    'Cable Curl (Bar)','Cable Curl (Rope)','Single-Arm Cable Curl',
    'Concentration Curl','Incline Dumbbell Curl','Spider Curl',
    '21s','Drag Curl','Zottman Curl','Machine Curl'
  ],
  triceps:[
    'Close-Grip Bench Press','Tricep Dips (Parallel Bars)','Bench Dips',
    'Skull Crushers (Barbell)','Skull Crushers (EZ Bar)','Skull Crushers (Dumbbell)',
    'Overhead Tricep Extension (Barbell)','Overhead Tricep Extension (Dumbbell)',
    'Overhead Tricep Extension (Cable)','Overhead Tricep Extension (EZ Bar)',
    'Cable Pushdown (Bar)','Cable Pushdown (Rope)','Reverse Cable Pushdown',
    'Single-Arm Cable Pushdown','Kickbacks (Dumbbell)','Kickbacks (Cable)',
    'Diamond Push-Ups','Tate Press','JM Press','Board Press'
  ],
  core:[
    'Plank','Side Plank','Plank with Hip Dips','RKC Plank',
    'Crunches','Bicycle Crunches','Reverse Crunches','Cable Crunches',
    'Sit-Ups','Decline Sit-Ups','V-Ups','Hollow Body Hold',
    'Leg Raises (Lying)','Hanging Knee Raises','Hanging Leg Raises','Toes to Bar',
    'Russian Twists','Weighted Russian Twists','Pallof Press','Cable Woodchop',
    'Ab Wheel Rollout','Barbell Rollout','Dragon Flag',
    'Mountain Climbers','Dead Bug','Bird Dog','Bear Crawl',
    'Landmine Twist','Suitcase Carry','Farmers Walk','Windmill'
  ],
  cardio:[
    'Treadmill Run','Incline Treadmill Walk','Stationary Bike','Assault Bike',
    'Rowing Machine','Elliptical','Stair Climber','Jump Rope',
    'Battle Ropes','Box Jumps','Burpees','Sled Push','Sled Pull',
    'Kettlebell Swings','Jumping Jacks','High Knees','Sprint Intervals'
  ],
  olympic:[
    'Power Clean','Hang Power Clean','Clean and Jerk','Snatch','Hang Snatch',
    'Push Press','Push Jerk','Split Jerk','Power Snatch','Romanian Deadlift to Shrug'
  ],
  forearms:[
    'Wrist Curl (Barbell)','Wrist Curl (Dumbbell)','Reverse Wrist Curl',
    'Farmers Walk','Plate Pinch','Towel Pull-Ups','Wrist Roller',
    'Grippers','Dead Hang','Behind-the-Back Wrist Curl'
  ]
};

// ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});
  // Migrate old localStorage keys if needed
  if(!localStorage.getItem('gc_workouts') && localStorage.getItem('workouts'))
    localStorage.setItem('gc_workouts', localStorage.getItem('workouts'));
  if(!localStorage.getItem('gc_history') && localStorage.getItem('workoutHistory'))
    localStorage.setItem('gc_history', localStorage.getItem('workoutHistory'));
  if(!localStorage.getItem('gc_measurements') && localStorage.getItem('measurements'))
    localStorage.setItem('gc_measurements', localStorage.getItem('measurements'));
  if(!localStorage.getItem('gc_meals') && localStorage.getItem('meals'))
    localStorage.setItem('gc_meals', localStorage.getItem('meals'));
  // Reload with migrated data
  workouts = JSON.parse(localStorage.getItem('gc_workouts')||'[]');
  workoutHistory = JSON.parse(localStorage.getItem('gc_history')||'[]');
  measurements = JSON.parse(localStorage.getItem('gc_measurements')||'[]');
  meals = JSON.parse(localStorage.getItem('gc_meals')||'[]');
  updateStats(); loadSavedWorkouts(); loadWorkoutHistory(); loadMeasurementHistory(); loadMeals();
  renderHomePicker();
});

// ‚îÄ‚îÄ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(name).classList.add('active');
}
function navTo(name,el){
  showPage(name);
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  el.classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Workout Picker ‚îÄ‚îÄ‚îÄ‚îÄ
let selectedWorkoutIndex = -1;

function getSmartSelectedIndex(){
  if(!workouts.length) return -1;
  if(!workoutHistory.length) return 0;
  // Find the last workout done and pick the next one in the list
  const lastDone = workoutHistory[workoutHistory.length - 1].name;
  const lastIdx = workouts.findIndex(w => w.name === lastDone);
  if(lastIdx === -1) return 0;
  return (lastIdx + 1) % workouts.length;
}

function renderHomePicker(){
  const container = document.getElementById('homeWorkoutPicker');
  const hint = document.getElementById('pickerHint');
  if(!workouts.length){
    container.innerHTML='<div class="picker-empty">No workouts yet ‚Äî go to the Workout tab to create one.</div>';
    hint.textContent='';
    return;
  }
  const smartIdx = getSmartSelectedIndex();
  if(selectedWorkoutIndex === -1 || selectedWorkoutIndex >= workouts.length){
    selectedWorkoutIndex = smartIdx;
  }
  const lastDoneName = workoutHistory.length ? workoutHistory[workoutHistory.length-1].name : null;
  hint.textContent = lastDoneName ? `Last: ${lastDoneName}` : 'First workout!';
  container.innerHTML = workouts.map((w, i) => {
    const isSelected = i === selectedWorkoutIndex;
    const isSmart = i === smartIdx;
    return `<div class="picker-option${isSelected?' selected':''}" onclick="selectWorkout(${i})">
      <div class="picker-radio"><div class="picker-radio-dot"></div></div>
      <div style="flex:1">
        <div class="picker-name">${w.name}</div>
        <div class="picker-meta">${w.exercises.length} exercises</div>
      </div>
      ${isSmart ? '<span class="picker-badge">Suggested</span>' : ''}
    </div>`;
  }).join('');
}

function selectWorkout(i){
  selectedWorkoutIndex = i;
  renderHomePicker();
}

function startSelectedWorkout(){
  if(!workouts.length){navTo('workout', document.querySelector('[data-page="workout"]'));return;}
  if(selectedWorkoutIndex < 0 || selectedWorkoutIndex >= workouts.length) selectedWorkoutIndex = 0;
  startWorkoutById(selectedWorkoutIndex);
}

function openCreateForm(){
  const sec = document.getElementById('workoutFormSection');
  sec.style.display = 'block';
  resetWorkoutForm();
  setTimeout(()=>sec.scrollIntoView({behavior:'smooth'}), 50);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats(){
  document.getElementById('totalWorkouts').textContent=workoutHistory.length;
  document.getElementById('currentStreak').textContent=calcStreak();
  const tw=workoutHistory.reduce((s,w)=>s+(w.totalWeight||0),0);
  document.getElementById('totalWeight').textContent=Math.round(tw);
  // Avg duration
  const avgEl=document.getElementById('avgDuration');
  if(avgEl){
    if(workoutHistory.length){
      const avg=Math.round(workoutHistory.reduce((s,w)=>s+(w.duration||0),0)/workoutHistory.length);
      avgEl.textContent=avg;
    } else { avgEl.textContent='‚Äî'; }
  }
  // Since date
  const sinceEl=document.getElementById('perfSince');
  if(sinceEl){
    if(workoutHistory.length){
      const first=new Date(workoutHistory[0].date);
      sinceEl.textContent='Since '+first.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    } else { sinceEl.textContent='No sessions yet'; }
  }
}
function calcStreak(){
  if(!workoutHistory.length)return 0;
  const sorted=[...workoutHistory].sort((a,b)=>new Date(b.date)-new Date(a.date));
  let streak=0,cur=new Date();
  for(const w of sorted){
    if(new Date(w.date).toDateString()===cur.toDateString()){
      streak++; cur.setDate(cur.getDate()-1);
    }else break;
  }
  return streak;
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Workout Create ‚îÄ‚îÄ‚îÄ‚îÄ
function addExercise(){
  exCount++;
  const list=document.getElementById('exerciseList');
  const div=document.createElement('div');
  div.className='exercise-card';
  div.innerHTML=`
    <div class="ex-card-header">
      <strong>Exercise ${exCount}</strong>
      <button class="remove-btn" onclick="this.closest('.exercise-card').remove()">Remove</button>
    </div>
    <div class="ex-one-row">
      <div class="ex-dropdowns">
        <select class="form-input muscle-sel" onchange="fillExercises(this)">
          <option value="">Muscle Group</option>
          ${Object.keys(exerciseDB).map(k=>`<option value="${k}">${k.charAt(0).toUpperCase()+k.slice(1)}</option>`).join('')}
        </select>
        <select class="form-input ex-sel" disabled><option value="">Select Exercise</option></select>
      </div>
      <div class="ex-numbers">
        <div class="ex-mini-field">
          <div class="ex-mini-label">Sets</div>
          <input type="number" class="form-input ex-sets" value="3" min="1">
        </div>
        <div class="ex-mini-field">
          <div class="ex-mini-label">Reps</div>
          <input type="number" class="form-input ex-reps" value="10" min="1">
        </div>
        <div class="ex-mini-field">
          <div class="ex-mini-label">Rest (s)</div>
          <input type="number" class="form-input ex-rest" value="60" min="0">
        </div>
      </div>
    </div>`;
  list.appendChild(div);
  setTimeout(()=>div.scrollIntoView({behavior:'smooth',block:'start'}),50);
}

function fillExercises(sel){
  const card=sel.closest('.exercise-card');
  const exSel=card.querySelector('.ex-sel');
  const mg=sel.value;
  if(!mg){exSel.disabled=true;exSel.innerHTML='<option>Select exercise</option>';return;}
  exSel.disabled=false;
  exSel.innerHTML='<option value="">Choose exercise</option>'+exerciseDB[mg].map(e=>`<option value="${e}">${e}</option>`).join('');
}

function saveWorkout(){
  const name=document.getElementById('workoutName').value.trim();
  if(!name)return toast('Please enter a workout name');
  const exercises=[];
  document.querySelectorAll('.exercise-card').forEach(card=>{
    const exName=card.querySelector('.ex-sel').value;
    const sets=parseInt(card.querySelector('.ex-sets').value)||0;
    const reps=parseInt(card.querySelector('.ex-reps').value)||0;
    const rest=parseInt(card.querySelector('.ex-rest').value)||60;
    if(exName&&sets&&reps)exercises.push({name:exName,sets,reps,rest});
  });
  if(!exercises.length)return toast('Add at least one complete exercise');
  if(editingIndex>=0){
    // Update existing
    workouts[editingIndex]={...workouts[editingIndex],name,exercises};
    toast('Workout updated! ‚úèÔ∏è');
  } else {
    workouts.push({id:Date.now(),name,exercises});
    toast('Workout saved! üí™');
  }
  localStorage.setItem('gc_workouts',JSON.stringify(workouts));
  resetWorkoutForm();
  loadSavedWorkouts();
  selectedWorkoutIndex = -1;
  renderHomePicker();
}

function resetWorkoutForm(){
  editingIndex=-1;
  document.getElementById('workoutName').value='';
  document.getElementById('exerciseList').innerHTML='';
  exCount=0;
  document.getElementById('saveWorkoutBtn').textContent='SAVE WORKOUT';
  document.getElementById('cancelEditBtn').style.display='none';
  document.getElementById('formTitle').textContent='CREATE NEW WORKOUT';
  document.getElementById('workoutFormSection').style.display='none';
}

function editWorkout(i){
  const w=workouts[i];
  editingIndex=i;
  document.getElementById('workoutName').value=w.name;
  document.getElementById('exerciseList').innerHTML='';
  exCount=0;
  document.getElementById('saveWorkoutBtn').textContent='UPDATE WORKOUT';
  document.getElementById('cancelEditBtn').style.display='block';
  document.getElementById('formTitle').textContent='EDITING: '+w.name.toUpperCase();
  // Load each exercise into the form
  w.exercises.forEach(ex=>{
    exCount++;
    const list=document.getElementById('exerciseList');
    const div=document.createElement('div');
    div.className='exercise-card';
    // Find muscle group for this exercise
    let foundMuscle='';
    for(const[mg,exList] of Object.entries(exerciseDB)){
      if(exList.includes(ex.name)){foundMuscle=mg;break;}
    }
    const exOptions=foundMuscle?exerciseDB[foundMuscle].map(e=>`<option value="${e}"${e===ex.name?' selected':''}>${e}</option>`).join(''):'';
    div.innerHTML=`
      <div class="ex-card-header">
        <strong>Exercise ${exCount}</strong>
        <button class="remove-btn" onclick="this.closest('.exercise-card').remove()">Remove</button>
      </div>
      <div class="ex-one-row">
        <div class="ex-dropdowns">
          <select class="form-input muscle-sel" onchange="fillExercises(this)">
            <option value="">Muscle Group</option>
            ${Object.keys(exerciseDB).map(k=>`<option value="${k}"${k===foundMuscle?' selected':''}>${k.charAt(0).toUpperCase()+k.slice(1)}</option>`).join('')}
          </select>
          <select class="form-input ex-sel">${exOptions}</select>
        </div>
        <div class="ex-numbers">
          <div class="ex-mini-field">
            <div class="ex-mini-label">Sets</div>
            <input type="number" class="form-input ex-sets" value="${ex.sets}" min="1">
          </div>
          <div class="ex-mini-field">
            <div class="ex-mini-label">Reps</div>
            <input type="number" class="form-input ex-reps" value="${ex.reps}" min="1">
          </div>
          <div class="ex-mini-field">
            <div class="ex-mini-label">Rest (s)</div>
            <input type="number" class="form-input ex-rest" value="${ex.rest}" min="0">
          </div>
        </div>
      </div>`;
    list.appendChild(div);
  });
  // Show and scroll to form
  document.getElementById('workoutFormSection').style.display='block';
  setTimeout(()=>document.getElementById('workoutFormSection').scrollIntoView({behavior:'smooth'}),50);
}

function deleteWorkout(i){
  if(!confirm(`Delete "${workouts[i].name}"?`))return;
  workouts.splice(i,1);
  localStorage.setItem('gc_workouts',JSON.stringify(workouts));
  if(editingIndex===i)resetWorkoutForm();
  loadSavedWorkouts();
  selectedWorkoutIndex = -1;
  renderHomePicker();
  toast('Workout deleted');
}

function loadSavedWorkouts(){
  const el=document.getElementById('savedWorkoutsList');
  if(!workouts.length){el.innerHTML='<div class="empty"><div class="empty-ico">üèóÔ∏è</div>No workouts yet. Create one above!</div>';return;}
  el.innerHTML=workouts.map((w,i)=>`
    <div class="workout-card">
      <div onclick="startWorkoutById(${i})" style="flex:1;cursor:pointer;">
        <div class="workout-card-name">${w.name}</div>
        <div class="workout-card-sub">${w.exercises.length} exercises</div>
      </div>
      <div class="workout-card-actions">
        <button class="wc-btn wc-edit" onclick="editWorkout(${i})">‚úèÔ∏è Edit</button>
        <button class="wc-btn wc-delete" onclick="deleteWorkout(${i})">üóëÔ∏è</button>
        <span class="workout-card-arrow" onclick="startWorkoutById(${i})" style="cursor:pointer;">‚ñ∂</span>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Active Workout ‚îÄ‚îÄ‚îÄ‚îÄ
function quickStart(){
  startSelectedWorkout();
}
function startWorkoutById(i){
  const w=workouts[i];
  currentWorkout={...w,startTime:Date.now(),completedSets:[],totalWeight:0};
  workoutStartTime=Date.now();
  document.getElementById('activeWorkoutName').textContent=w.name;
  showPage('activeWorkout');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  renderProgress();
  startWorkoutTimer();
}

function renderProgress(){
  const c=document.getElementById('exerciseProgress');
  c.innerHTML='';
  currentWorkout.exercises.forEach((ex,ei)=>{
    const div=document.createElement('div');
    div.className='ex-progress';
    let rows='';
    for(let si=0;si<ex.sets;si++){
      const id=ei+'-'+si;
      const done=currentWorkout.completedSets.includes(id);
      rows+='<div class="set-row'+(done?' done':'')+'" id="row-'+id+'">'
        +'<div class="set-num">'+(si+1)+'</div>'
        +'<input class="set-input" type="number" placeholder="kg" id="wt-'+id+'"'+(done?' disabled':'')+'>'
        +'<input class="set-input" type="number" placeholder="reps" value="'+ex.reps+'" id="rp-'+id+'"'+(done?' disabled':'')+'>'
        +'<div class="set-status" id="sts-'+id+'">'+(done?'&#10003;':'')+'</div>'
        +'</div>';
    }
    const head='<div class="ex-progress-head">'
      +'<div>'
      +'<div class="ex-name">'+ex.name+'</div>'
      +'<div class="ex-meta">'+ex.sets+' sets \u00d7 '+ex.reps+' reps \u00b7 '+ex.rest+'s rest</div>'
      +'</div>'
      +'<button class="rep-play-btn" id="playbtn-'+ei+'" onclick="startRepCounter('+ei+')">&#9654; START</button>'
      +'</div>';
    const panel='<div class="rep-counter-panel" id="rcp-'+ei+'" style="display:none;">'
      +'<div class="rcp-label" id="rcp-label-'+ei+'">SET 1</div>'
      +'<div class="rcp-count" id="rcp-count-'+ei+'">0</div>'
      +'<div class="rcp-target" id="rcp-target-'+ei+'">of '+ex.reps+' reps</div>'
      +'<div class="rcp-status" id="rcp-status-'+ei+'"></div>'
      +'</div>';
    div.innerHTML=head+panel+rows;
    c.appendChild(div);
  });
}


// ‚îÄ‚îÄ‚îÄ‚îÄ Rep Counter State Machine ‚îÄ‚îÄ‚îÄ‚îÄ
// Token-based: incrementing repToken cancels ALL pending setTimeout callbacks.
// Flow per exercise: speak 1..N (REP_GAP apart) ‚Üí mark set done ‚Üí rest countdown ‚Üí speak Go ‚Üí next set
const REP_GAP = 1800;   // ms between voiced rep counts (time to actually do the rep)
const REST_TICK = 1000; // ms per rest-second tick

let repState = null;  // { ei, si, target, restSecs, token }
let repToken = 0;     // ever-increasing; each doRep/doRest checks its own captured token

function startRepCounter(ei){
  stopRepCounter();
  if(!currentWorkout) return;
  const ex = currentWorkout.exercises[ei];
  // Find first incomplete set
  let firstSet = 0;
  for(let si=0;si<ex.sets;si++){
    if(!currentWorkout.completedSets.includes(`${ei}-${si}`)){firstSet=si;break;}
  }
  const tok = ++repToken;
  repState = {ei, si:firstSet, target:ex.reps, restSecs:ex.rest, token:tok};
  document.getElementById(`rcp-${ei}`).style.display='flex';
  const btn=document.getElementById(`playbtn-${ei}`);
  btn.textContent='‚èπ STOP';
  btn.onclick=()=>stopRepCounter();
  // Show countdown panel then start reps
  doCountdown(tok, ei, firstSet, 3);
}

function doCountdown(tok, ei, si, n){
  if(repToken !== tok || !repState) return;
  const target = repState.target;
  document.getElementById(`rcp-label-${ei}`).textContent = 'GET READY';
  document.getElementById(`rcp-count-${ei}`).textContent = n;
  document.getElementById(`rcp-target-${ei}`).textContent = 'Starting in...';
  document.getElementById(`rcp-status-${ei}`).textContent = '';
  silenceVoice();
  speak(String(n));
  if(n > 1){
    setTimeout(()=> doCountdown(tok, ei, si, n-1), 1000);
  } else {
    // After "1", brief pause then say "Go" and start reps
    setTimeout(()=>{
      if(repToken !== tok || !repState) return;
      silenceVoice();
      speak('Go');
      document.getElementById(`rcp-count-${ei}`).textContent = '0';
      document.getElementById(`rcp-target-${ei}`).textContent = 'of '+target+' reps';
      document.getElementById(`rcp-label-${ei}`).textContent = 'SET '+(si+1);
      setTimeout(()=> doRep(tok, ei, si, 1), 900);
    }, 1000);
  }
}

function doRep(tok, ei, si, repNum){
  if(repToken !== tok || !repState) return; // cancelled
  const target = repState.target;
  // Update display
  document.getElementById(`rcp-label-${ei}`).textContent = `SET ${si+1}`;
  document.getElementById(`rcp-count-${ei}`).textContent = repNum;
  document.getElementById(`rcp-target-${ei}`).textContent = `of ${target} reps`;
  document.getElementById(`rcp-status-${ei}`).textContent = '';
  // Speak rep number (cancel first so no overlap)
  silenceVoice();
  speak(String(repNum));
  if(repNum < target){
    setTimeout(()=> doRep(tok, ei, si, repNum+1), REP_GAP);
  } else {
    // All reps done for this set
    setTimeout(()=>{
      if(repToken !== tok || !repState) return;
      markSetDone(ei, si);
      const ex = currentWorkout.exercises[ei];
      const nextSi = si + 1;
      if(nextSi < ex.sets){
        repState.si = nextSi;
        doRest(tok, ei, nextSi, repState.restSecs);
      } else {
        // Exercise complete
        document.getElementById(`rcp-count-${ei}`).textContent = '‚úì';
        document.getElementById(`rcp-status-${ei}`).textContent = 'All sets done!';
        const btn=document.getElementById(`playbtn-${ei}`);
        btn.textContent='‚úì DONE'; btn.disabled=true;
        silenceVoice();
        repState=null;
      }
    }, REP_GAP);
  }
}

function doRest(tok, ei, nextSi, rem){
  if(repToken !== tok || !repState) return; // cancelled
  // Update display to show rest countdown
  document.getElementById(`rcp-label-${ei}`).textContent = 'REST';
  document.getElementById(`rcp-count-${ei}`).textContent = rem;
  document.getElementById(`rcp-target-${ei}`).textContent = 'seconds';
  document.getElementById(`rcp-status-${ei}`).textContent = `Next ‚Üí Set ${nextSi+1}`;
  // Speak only on 3, 2, 1
  silenceVoice();
  if(rem===3||rem===2||rem===1) speak(String(rem));
  if(rem > 0){
    setTimeout(()=> doRest(tok, ei, nextSi, rem-1), REST_TICK);
  } else {
    // Rest over ‚Äî start next set
    speak('Go');
    setTimeout(()=> doRep(tok, ei, nextSi, 1), 900);
  }
}

function markSetDone(ei, si){
  const id=`${ei}-${si}`;
  if(currentWorkout.completedSets.includes(id)) return;
  const wt=parseFloat(document.getElementById(`wt-${id}`).value)||0;
  const rp=repState ? repState.target : (parseInt(document.getElementById(`rp-${id}`).value)||0);
  currentWorkout.completedSets.push(id);
  currentWorkout.totalWeight += wt*rp;
  const row=document.getElementById(`row-${id}`);
  if(row) row.classList.add('done');
  const sts=document.getElementById(`sts-${id}`);
  if(sts) sts.textContent='‚úì';
  // Check full workout done
  const allDone=currentWorkout.exercises.every((ex,eIdx)=>
    Array.from({length:ex.sets},(_,sIdx)=>`${eIdx}-${sIdx}`)
      .every(id2=>currentWorkout.completedSets.includes(id2))
  );
  if(allDone) setTimeout(endWorkout, 2000);
}

function stopRepCounter(){
  repToken++; // invalidates all pending doRep/doRest callbacks
  silenceVoice();
  if(!repState) return;
  const ei = repState.ei;
  repState = null;
  const panel=document.getElementById(`rcp-${ei}`);
  if(panel) panel.style.display='none';
  const btn=document.getElementById(`playbtn-${ei}`);
  if(btn&&!btn.disabled){
    btn.textContent='‚ñ∂ START';
    btn.onclick=()=>startRepCounter(ei);
  }
}


function completeSet(id,ei,si){
  // Manual done (fallback)
  if(currentWorkout.completedSets.includes(id))return;
  const wt=parseFloat(document.getElementById(`wt-${id}`).value)||0;
  const rp=parseInt(document.getElementById(`rp-${id}`).value)||0;
  currentWorkout.completedSets.push(id);
  currentWorkout.totalWeight+=wt*rp;
  const row=document.getElementById(`row-${id}`);
  row.classList.add('done');
  document.getElementById(`sts-${id}`).textContent='‚úì';
  const ex=currentWorkout.exercises[ei];
  if(si<ex.sets-1){startRest(ex.rest);}
  else if(ei===currentWorkout.exercises.length-1){setTimeout(endWorkout,2000);}
}

function startWorkoutTimer(){
  workoutTimerInt=setInterval(()=>{
    const e=Date.now()-workoutStartTime;
    const m=Math.floor(e/60000),s=Math.floor((e%60000)/1000);
    document.getElementById('workoutTimer').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  },1000);
}

function startRest(secs){
  let rem=secs;
  document.getElementById('restNum').textContent=rem;
  document.getElementById('restOverlay').classList.add('show');
  restTimerInt=setInterval(()=>{
    rem--;
    document.getElementById('restNum').textContent=rem;
    if(rem<=0){skipRest();}
  },1000);
}
function skipRest(){
  clearInterval(restTimerInt);
  document.getElementById('restOverlay').classList.remove('show');
}

function endWorkout(){
  clearInterval(workoutTimerInt);clearInterval(restTimerInt);
  document.getElementById('restOverlay').classList.remove('show');
  const dur=Math.floor((Date.now()-workoutStartTime)/60000);
  workoutHistory.push({name:currentWorkout.name,date:new Date().toISOString(),
    duration:dur,totalWeight:currentWorkout.totalWeight,exercises:currentWorkout.exercises.length});
  localStorage.setItem('gc_history',JSON.stringify(workoutHistory));
  currentWorkout=null;
  updateStats();loadWorkoutHistory();
  navTo('home',document.querySelector('[data-page="home"]'));
  toast('Workout saved! üî•');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Progress ‚îÄ‚îÄ‚îÄ‚îÄ
function saveMeasurement(){
  const w=parseFloat(document.getElementById('weightInput').value);
  if(!w)return toast('Enter your weight');
  const bf=parseFloat(document.getElementById('bodyFatInput').value)||null;
  measurements.push({date:new Date().toISOString(),weight:w,bodyFat:bf});
  localStorage.setItem('gc_measurements',JSON.stringify(measurements));
  document.getElementById('weightInput').value='';
  document.getElementById('bodyFatInput').value='';
  loadMeasurementHistory();
  toast('Measurement saved');
}
function loadMeasurementHistory(){
  const el=document.getElementById('measurementHistory');
  if(!measurements.length){el.innerHTML='<div class="empty"><div class="empty-ico">‚öñÔ∏è</div>No measurements yet</div>';return;}
  el.innerHTML=[...measurements].reverse().slice(0,8).map(m=>`
    <div class="history-row">
      <div class="history-row-left">
        <strong>${new Date(m.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</strong>
        <span>Body measurement</span>
      </div>
      <div class="history-row-right">
        <div class="history-val">${m.weight} kg</div>
        <div class="history-val-sub">${m.bodyFat?m.bodyFat+'% BF':'‚Äî'}</div>
      </div>
    </div>`).join('');
}
function loadWorkoutHistory(){
  const el=document.getElementById('workoutHistory');
  if(!workoutHistory.length){el.innerHTML='<div class="empty"><div class="empty-ico">üèãÔ∏è</div>No workouts logged yet</div>';return;}
  el.innerHTML=[...workoutHistory].reverse().slice(0,8).map(w=>`
    <div class="history-row">
      <div class="history-row-left">
        <strong>${w.name}</strong>
        <span>${new Date(w.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})} ¬∑ ${w.duration} min</span>
      </div>
      <div class="history-row-right">
        <div class="history-val">${Math.round(w.totalWeight)}</div>
        <div class="history-val-sub">kg lifted</div>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Nutrition ‚îÄ‚îÄ‚îÄ‚îÄ
const TARGETS={cal:2500,pro:150,carb:300,fat:80};
function logMeal(){
  const name=document.getElementById('mealName').value.trim();
  const cal=parseInt(document.getElementById('mealCal').value)||0;
  if(!name||!cal)return toast('Enter meal name and calories');
  meals.push({date:new Date().toDateString(),name,cal,
    pro:parseInt(document.getElementById('mealPro').value)||0,
    carb:parseInt(document.getElementById('mealCarb').value)||0,
    fat:parseInt(document.getElementById('mealFat').value)||0});
  localStorage.setItem('gc_meals',JSON.stringify(meals));
  ['mealName','mealCal','mealPro','mealCarb','mealFat'].forEach(id=>document.getElementById(id).value='');
  loadMeals();
  toast('Meal logged ü•ó');
}
function loadMeals(){
  const today=new Date().toDateString();
  const tm=meals.filter(m=>m.date===today);
  const totals={cal:0,pro:0,carb:0,fat:0};
  tm.forEach(m=>{totals.cal+=m.cal;totals.pro+=m.pro;totals.carb+=m.carb;totals.fat+=m.fat;});
  document.getElementById('calConsumed').textContent=totals.cal;
  document.getElementById('proConsumed').textContent=totals.pro;
  document.getElementById('carbConsumed').textContent=totals.carb;
  document.getElementById('fatConsumed').textContent=totals.fat;
  document.getElementById('calBar').style.width=Math.min(100,totals.cal/TARGETS.cal*100)+'%';
  document.getElementById('proBar').style.width=Math.min(100,totals.pro/TARGETS.pro*100)+'%';
  document.getElementById('carbBar').style.width=Math.min(100,totals.carb/TARGETS.carb*100)+'%';
  document.getElementById('fatBar').style.width=Math.min(100,totals.fat/TARGETS.fat*100)+'%';
  const el=document.getElementById('mealsList');
  if(!tm.length){el.innerHTML='<div class="empty"><div class="empty-ico">üçΩÔ∏è</div>No meals logged today</div>';return;}
  el.innerHTML=[...tm].reverse().map(m=>`
    <div class="meal-item">
      <div class="meal-name">${m.name}</div>
      <div class="meal-macros">
        <span>üî• ${m.cal} kcal</span>
        <span>P ${m.pro}g</span>
        <span>C ${m.carb}g</span>
        <span>F ${m.fat}g</span>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ Voice ‚îÄ‚îÄ‚îÄ‚îÄ
function speak(text){
  if('speechSynthesis' in window){
    speechSynthesis.cancel(); // clear any queued speech first
    const u=new SpeechSynthesisUtterance(text);
    u.rate=1.1;u.pitch=1.0;
    speechSynthesis.speak(u);
  }
}
function silenceVoice(){
  if('speechSynthesis' in window) speechSynthesis.cancel();
}
</script>
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(r => console.log('SW registered'))
      .catch(e => console.log('SW failed', e));
  });
}
</script>
</body>
</html>
